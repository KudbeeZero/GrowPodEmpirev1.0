name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Note: `npm run check` currently reports 14 known TypeScript errors in 3 files.
      # These type inference issues do not block the build and are accepted for now,
      # but we enforce that the error count does not increase beyond 14.
      - name: Type check
        run: |
          # Run type checking, capture all output, but do not fail the job yet.
          npm run check 2>&1 | tee typecheck.log || true

      - name: Enforce TypeScript error budget
        run: |
          # Count TypeScript errors in the typecheck.log file.
          # This assumes standard tsc-style messages containing "error TS<code>:"
          # and avoids masking failures with a blanket `|| true` on the pipeline.
          if [ -f typecheck.log ]; then
            ERROR_COUNT=$(grep -E -c "error TS[0-9]{4}:" typecheck.log || echo 0)
          else
            echo "typecheck.log not found; assuming 0 TypeScript errors."
            ERROR_COUNT=0
          fi

          echo "Detected TypeScript errors: ${ERROR_COUNT}"

          # Allow up to 14 known errors, but fail if the count increases.
          if [ "${ERROR_COUNT}" -gt 14 ]; then
            echo "TypeScript error count (${ERROR_COUNT}) exceeds the allowed maximum of 14."
            exit 1
          fi
      - name: Build application
        run: npm run build

      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
        env:
          # Pass any required build-time environment variables
          NODE_ENV: production
